<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Codename → Psych Converter</title>
<style>
  body {
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    background: #0d1117;
    color: #e6edf3;
  }
  .dropzone {
    border: 2px dashed #58a6ff;
    border-radius: 10px;
    padding: 60px;
    text-align: center;
    width: 400px;
    transition: 0.3s;
  }
  .dropzone.dragover {
    background: rgba(88,166,255,0.1);
    border-color: #79c0ff;
  }
  button {
    margin-top: 20px;
    background: #238636;
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.2s;
  }
  button:hover {
    background: #2ea043;
  }
</style>
</head>
<body>
  <h1>Codename → Psych Converter</h1>
  <div class="dropzone" id="dropzone">Drag & Drop your Codename file here or click to select</div>
  <input type="file" id="fileInput" hidden>
  <button id="convertBtn" disabled>Convert File</button>

  <script>
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const convertBtn = document.getElementById('convertBtn');
    let selectedFile = null;

    dropzone.addEventListener('click', () => fileInput.click());

    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      selectedFile = e.dataTransfer.files[0];
      dropzone.textContent = `Loaded: ${selectedFile.name}`;
      convertBtn.disabled = false;
    });

    fileInput.addEventListener('change', (e) => {
      selectedFile = e.target.files[0];
      dropzone.textContent = `Loaded: ${selectedFile.name}`;
      convertBtn.disabled = false;
    });

    convertBtn.addEventListener('click', async () => {
      if (!selectedFile) return alert('No file selected!');
      const text = await selectedFile.text();

      // Placeholder converter logic — replace with actual Codename → Psych conversion
      const converted = text
        .replaceAll('codename', 'psych')
        .replaceAll('Codename', 'Psych')
        .replaceAll('flixel', 'funkin');

      const blob = new Blob([converted], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = selectedFile.name.replace(/\.[^.]+$/, '') + '_psych.hx';
      a.click();
    });
  </script>
</body>
</html>
    // Build resource path for Psych: convention 'stages/{folder}/{spriteName}'
    let base = folder || '';
    if(!keepCase) base = base.toLowerCase();
    // remove trailing slash
    base = base.replace(/\/+$/, '')
    if(base && !base.endsWith('/')) base += '/'
    return base + spriteName
  }

  const parts = []
  parts.push("function onCreate()")

  // sprites
  const sprites = Array.from(stage.querySelectorAll('sprite'))
  sprites.forEach(sp =>{
    const sname = attr(sp, 'name', attr(sp,'sprite','sprite'))
    const spriteFile = attr(sp, 'sprite', sname)
    const x = n2f(attr(sp,'x',0));
    const y = n2f(attr(sp,'y',0));
    const scale = attr(sp,'scale', null);
    const antialiasing = attr(sp,'antialiasing', null);
    const updateHitbox = attr(sp,'updateHitbox', null);
    const scrollx = attr(sp,'scrollx', null);
    const scrolly = attr(sp,'scrolly', null);

    parts.push(`    makeLuaSprite('${sname}', '${resPath(spriteFile)}', ${x}, ${y});`)
    if(scrollx !== null || scrolly !== null){
      const sx = scrollx!==null ? parseFloat(scrollx) : 1
      const sy = scrolly!==null ? parseFloat(scrolly) : sx
      parts.push(`    setScrollFactor('${sname}', ${sx}, ${sy});`)
    } else {
      parts.push(`    setScrollFactor('${sname}', 1, 1);`)
    }
    if(scale !== null) {
      const s = parseFloat(scale)
      parts.push(`    scaleLuaSprite('${sname}', ${s}, ${s});`)
    }
    parts.push(`    addLuaSprite('${sname}', false);`)
    if(antialiasing !== null) parts.push(`    setProperty('${sname}.antialiasing', ${antialiasing === 'true' ? 'true' : 'false'});`)
    if(updateHitbox === 'true') parts.push(`    updateHitbox('${sname}');`)
    parts.push('')
  })

  // gf, dad, boyfriend
  const gf = stage.querySelector('girlfriend')
  if(gf){
    const gx=n2f(attr(gf,'x',0)); const gy=n2f(attr(gf,'y',0)); const alpha=attr(gf,'alpha',null);
    parts.push(`    -- girlfriend`) 
    parts.push(`    setProperty('gf.x', ${gx});`)
    parts.push(`    setProperty('gf.y', ${gy});`)
    if(alpha!==null) parts.push(`    setProperty('gf.alpha', ${parseFloat(alpha)});`)
    parts.push('')
  }
  const dad = stage.querySelector('dad')
  if(dad){ const dx=n2f(attr(dad,'x',0)); const dy=n2f(attr(dad,'y',0)); const cx=attr(dad,'camxoffset',null); const cy=attr(dad,'camyoffset',null);
    parts.push(`    -- dad`) 
    parts.push(`    setProperty('dad.x', ${dx});`)
    parts.push(`    setProperty('dad.y', ${dy});`)
    if(cx!==null || cy!==null){ const cxv = cx?parseFloat(cx):0; const cyv = cy?parseFloat(cy):0; parts.push(`    setProperty('dadCameraOffset', {${cxv}, ${cyv}});`) }
    parts.push('') }
  const bf = stage.querySelector('boyfriend')
  if(bf){ const bx=n2f(attr(bf,'x',0)); const by=n2f(attr(bf,'y',0)); const cx=attr(bf,'camxoffset',null); const cy=attr(bf,'camyoffset',null);
    parts.push(`    -- boyfriend`) 
    parts.push(`    setProperty('boyfriend.x', ${bx});`)
    parts.push(`    setProperty('boyfriend.y', ${by});`)
    if(cx!==null || cy!==null){ const cxv = cx?parseFloat(cx):0; const cyv = cy?parseFloat(cy):0; parts.push(`    setProperty('boyfriendCameraOffset', {${cxv}, ${cyv}});`) }
    parts.push('') }

  parts.push('end')

  // onCreatePost for zooms and skins
  if(opts.includeCreatePost){
    const post = []
    if(zoom!==null || gfZoom!==null || noteSkin!==null || timeBarSkin!==null){
      post.push('\nfunction onCreatePost()')
      if(zoom!==null) post.push(`    setProperty('defaultCamZoom', ${parseFloat(zoom)});`)
      if(gfZoom!==null) post.push(`    setProperty('defaultGFZoom', ${parseFloat(gfZoom)});`)
      if(timeBarSkin!==null) post.push(`    -- timeBarSkin: ${timeBarSkin} (use setTimeBarColors or custom graphic)
    -- setTimeBarColors('FFFFFF','BFBFBF')`)
      if(noteSkin!==null) post.push(`    -- noteSkin: ${noteSkin} (you may want to add noteskin change script)`) 
      post.push('end')
    }
    parts.push(post.join('\n'))
  }

  return parts.join('\n')
}

// Simple hx -> lua mid-song converter (best-effort)
function hxToLua(hxText){
  if(!hxText || !hxText.trim()) return '';
  const lines = hxText.split(/\r?\n/);
  let lua = '\n-- Converted mid-song logic (best-effort)\nfunction onStepHit()\n';
  // find simple patterns: if (step == N) vid.play(); and vid.visible = false;
  const playRegex = /if\s*\(step\s*==\s*(\d+)\)\s*{?\s*vid\.play\(\)\s*;?\s*}?/i;
  const visOffRegex = /if\s*\(step\s*==\s*(\d+)\)\s*{?\s*vid\.visible\s*=\s*false\s*;?\s*}?/i;
  for(const l of lines){
    let m;
    if(m = l.match(playRegex)){
      lua += `    if curStep == ${m[1]} then\n        -- start video (ensure you loaded it as a Lua video or use startVideo)\n        startVideo('bargain')\n    end\n`;
    }
    if(m = l.match(visOffRegex)){
      lua += `    if curStep == ${m[1]} then\n        -- hide video or sprite\n        setProperty('bargain.visible', false)\n    end\n`;
    }
  }
  lua += 'end\n'
  return lua
}

// UI wiring
const xmlInput = document.getElementById('xmlInput')
const hxInput = document.getElementById('hxInput')
const out = document.getElementById('output')
const convertBtn = document.getElementById('convertBtn')
const downloadBtn = document.getElementById('downloadBtn')
const copyBtn = document.getElementById('copyBtn')
const exampleBtn = document.getElementById('exampleBtn')

convertBtn.addEventListener('click', ()=>{
  const lua = xmlToLua(xmlInput.value, {includeCreatePost: document.getElementById('includeCreatePost').checked, camelCasePaths: document.getElementById('camelCasePaths').checked})
  const mid = hxToLua(hxInput.value)
  out.textContent = lua + (mid ? '\n' + mid : '')
})

copyBtn.addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(out.textContent); alert('copied!') }catch(e){ alert('copy failed') }
})

downloadBtn.addEventListener('click', ()=>{
  const blob = new Blob([out.textContent], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'converted_stage.lua'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
})

exampleBtn.addEventListener('click', ()=>{
  xmlInput.value = `<!DOCTYPE codename-engine-stage>\n<stage folder="stages/dustshift/" name="dustshift" zoom="0.55" gfZoom="0.43" noteSkin="cornered" timeBarSkin="waterfall">\n    <sprite x=\"-280\" sprite=\"red\" y=\"0\" name=\"red\" scale=\"1.26\" antialiasing=\"true\" updateHitbox=\"true\"/>\n    <sprite x=\"1080\" sprite=\"school\" y=\"1000\" name=\"school\" scale=\"10\" antialiasing=\"false\"/>\n    <girlfriend x=\"1000\" y=\"1049\" alpha=\"0\"/>\n    <dad x=\"250\" y=\"1320\" camyoffset=\"-50\" camxoffset=\"200\"/>\n    <boyfriend x=\"1920\" y=\"1550\" camxoffset=\"-400\" camyoffset=\"-50\"/>\n</stage>`;
  hxInput.value = `function stepHit(step:Int) {\n    if (step == 1) { vid.play(); }\n    if (step == 156) { vid.visible = false; }\n}`;
})
</script>
</body>
</html>
