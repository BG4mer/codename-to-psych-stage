<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Codename ‚Üí Psych Engine Converter</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Space Mono', monospace; background:#1a1a2e; color:#e94560; min-height:100vh; padding:2rem; display:flex; flex-direction:column; align-items:center;}
  .container { max-width:800px; width:100%; background:rgba(0,0,0,0.7); backdrop-filter:blur(10px); border-radius:20px; padding:2rem; border:1px solid rgba(233,69,96,0.2);}
  h1 { text-align:center; margin-bottom:2rem; font-size:1.8rem; font-weight:700; background:linear-gradient(45deg,#e94560,#f27121); -webkit-background-clip:text; -webkit-text-fill-color:transparent;}
  .file-input-wrapper { position: relative; margin: 1rem 0; width:100%; }
  .file-input { position:absolute; left:-9999px; }
  .file-input-label { display:block; padding:1rem; background:linear-gradient(135deg,#0f3460,#533483); color:white; border-radius:10px; cursor:pointer; text-align:center; border:2px solid transparent; transition: all 0.3s;}
  .file-input-label:hover { background:linear-gradient(135deg,#533483,#0f3460); border-color:#e94560; }
  .file-input-label.has-file { background:linear-gradient(135deg,#e94560,#f27121); animation:pulse 2s infinite;}
  @keyframes pulse {0%,100%{opacity:1;}50%{opacity:0.8;}}
  .button-group { display:flex; gap:1rem; margin:2rem 0; }
  button { flex:1; padding:1rem 2rem; background:linear-gradient(135deg,#e94560,#f27121); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:700; position:relative; overflow:hidden; transition:0.3s;}
  button:hover { transform:translateY(-3px); box-shadow:0 10px 20px rgba(233,69,96,0.3);}
  button:disabled { opacity:0.5; cursor:not-allowed; }
  textarea { width:100%; height:400px; background:#0a0a0a; color:#00ff41; font-family:'Space Mono', monospace; font-size:0.9rem; border:2px solid #333; border-radius:10px; padding:1rem; resize:vertical;}
  .status { margin:1rem 0; padding:1rem; border-radius:10px; text-align:center; font-weight:700; opacity:0; transition:0.3s;}
  .status.show { opacity:1; }
  .status.success { background: rgba(46,204,113,0.2); border:1px solid #2ecc71; color:#2ecc71; }
  .status.error { background: rgba(231,76,60,0.2); border:1px solid #e74c3c; color:#e74c3c; }
</style>
</head>
<body>
<div class="container">
  <h1>üéµ Codename ‚Üí Psych Engine Converter</h1>

  <div class="file-input-wrapper">
    <input type="file" id="xmlInput" accept=".xml" class="file-input" multiple>
    <label for="xmlInput" class="file-input-label" id="xmlLabel">üìÅ Select Codename XML file(s)</label>
  </div>

  <div class="file-input-wrapper">
    <input type="file" id="hxInput" accept=".hx" class="file-input" multiple>
    <label for="hxInput" class="file-input-label" id="hxLabel">üìú Select Codename HX file(s) (optional)</label>
  </div>

  <div class="status" id="status"></div>

  <div class="button-group">
    <button onclick="convert()" id="convertBtn" disabled>‚ú® Convert to Psych</button>
    <button onclick="download()" id="downloadBtn" disabled>üíæ Download LUA</button>
  </div>

  <textarea id="output" placeholder="üöÄ Your converted LUA code will appear here..."></textarea>
</div>

<script>
let xmlFiles = [];
let hxFiles = [];
let outputContent = '';
let stageCounter = 1;

function showStatus(msg,type){ 
  const s=document.getElementById('status'); 
  s.textContent=msg; 
  s.className=`status ${type} show`; 
  setTimeout(()=>{s.classList.remove('show');},3000);
}

function updateButtons(){ 
  document.getElementById('convertBtn').disabled = xmlFiles.length === 0; 
  document.getElementById('downloadBtn').disabled = !outputContent.trim(); 
}

// Handle XML input
document.getElementById('xmlInput').addEventListener('change', e=>{
  xmlFiles = Array.from(e.target.files);
  const label=document.getElementById('xmlLabel');
  if(xmlFiles.length){ 
    label.textContent=`‚úÖ ${xmlFiles.length} XML file(s) selected`; 
    label.classList.add('has-file'); 
    showStatus('‚úÖ XML files loaded','success'); 
    updateButtons();
  }
});

// Handle HX input
document.getElementById('hxInput').addEventListener('change', e=>{
  hxFiles = Array.from(e.target.files);
  const label=document.getElementById('hxLabel');
  if(hxFiles.length){ 
    label.textContent=`‚úÖ ${hxFiles.length} HX file(s) selected`; 
    label.classList.add('has-file'); 
    showStatus('‚úÖ HX files loaded','success'); 
    updateButtons();
  }
});

// Extract sprites from XML
function extractSpritesFromXML(xmlText){
  const lines = xmlText.split('\n').filter(l=>l.includes('<sprite'));
  return lines.map(line=>{
    const name = (line.match(/name="(.*?)"/)||[])[1]||'sprite';
    const path = (line.match(/sprite="(.*?)"/)||[])[1]||'unknown';
    const x = (line.match(/x="(.*?)"/)||[])[1]||0;
    const y = (line.match(/y="(.*?)"/)||[])[1]||0;
    const scale = (line.match(/scale="(.*?)"/)||[])[1]||1;
    return {name,path,x,y,scale};
  });
}

// Extract step events from HX file
function extractStepEvents(hxText){
  const stepEvents = [];
  const regex = /onStep\((\d+),\s*function\(\)\s*{([\s\S]*?)}\)/g;
  let match;
  while((match = regex.exec(hxText)) !== null){
    const step = parseInt(match[1]);
    const code = match[2].trim().replace(/\n/g,'\n\t');
    stepEvents.push({step,code});
  }
  return stepEvents;
}

// Convert function using valid Psych Engine functions
async function convert(){
  if(xmlFiles.length===0){ showStatus('‚ùå No XML files selected','error'); return; }
  outputContent = '-- Psych Engine Lua generated\n\nfunction onCreate()\n';
  
  for(const file of xmlFiles){
    const text = await file.text();
    const sprites = extractSpritesFromXML(text);
    for(const s of sprites){
      outputContent += `makeLuaSprite('${s.name}','${s.path}',${s.x},${s.y})\n`;
      outputContent += `scaleObject('${s.name}',${s.scale},${s.scale})\n`;
      outputContent += `addLuaSprite('${s.name}', false)\n\n`;
    }
  }

  outputContent += 'end\n\n';

  // Process HX step events
  let stepEventCount = 0;
  for(const hx of hxFiles){
    const hxText = await hx.text();
    const steps = extractStepEvents(hxText);
    if(steps.length){
      outputContent += 'function onStepHit()\n';
      steps.forEach(s=>{
        outputContent += `\tif curStep == ${s.step} then\n\t\t${s.code}\n\tend\n`;
        stepEventCount++;
      });
      outputContent += 'end\n\n';
    }
  }

  document.getElementById('output').value = outputContent;
  showStatus(`üéâ Conversion completed! ${stepEventCount} step event(s) detected.`,'success');
  updateButtons();
}

// Download function
function download(){
  if(!outputContent.trim()){ showStatus('‚ùå No content to download','error'); return; }
  const blob = new Blob([outputContent], {type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='stage_psych_'+stageCounter+'.lua';
  stageCounter++;
  a.click();
  showStatus('üíæ LUA file downloaded!','success');
}

// Initialize button states
updateButtons();
</script>
</body>
</html>
